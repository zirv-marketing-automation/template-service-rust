# syntax=docker/dockerfile:1
# Development Dockerfile with hot reload support

FROM rust:1.90

WORKDIR /usr/src/app

# Install system dependencies and cargo-watch for hot reload
RUN apt-get update && apt-get install -y pkg-config libssl-dev && rm -rf /var/lib/apt/lists/*
RUN cargo install cargo-watch

# Copy manifests
COPY Cargo.toml Cargo.lock ./
COPY backend/Cargo.toml backend/Cargo.toml

# Pre-fetch dependencies
RUN mkdir backend/src && \
    echo 'fn main() {}' > backend/src/main.rs && \
    cargo build -p backend && \
    rm -r backend/src

# The actual source will be mounted as a volume for hot reload
# This allows changes on the host to trigger rebuilds in the container

EXPOSE 3000
ENV RUST_LOG=debug

# Use cargo-watch to watch for changes and rebuild/restart
CMD ["cargo", "watch", "-x", "run -p backend", "-w", "backend/src", "-w", "backend/Cargo.toml"]
